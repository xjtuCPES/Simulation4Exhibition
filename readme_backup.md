
[![forthebadge](https://forthebadge.com/images/badges/made-with-python.svg)](https://forthebadge.com)


[![forthebadge](https://forthebadge.com/images/badges/built-with-love.svg)](https://forthebadge.com)

[![forthebadge](Img/powered-by-guo.svg)](https://github.com/gwyxjtu)

# **设备运行决策**
- 代码负责人：刘晋辉、董翔翔、郭王懿
- 主要内容：分为日前决策和日内决策，其中日前决策根据后一天24h的负荷预测和光伏预测，计算出下一日的基策略；日内决策根据当前时刻的储能状态和未来四小时的负荷预测和当日的基策略，做出4小时的决策。

## **0. 代码功能解释**
本代码负责优化决策部分的设备运行决策。日前决策在每日0时运行，根据下一日的光照强度和负荷预测水平，决策得到下一日设备运行策略；日内决策在日内每小时运行，根据未来四小时负荷和光照，决策得到4小时的设备运行策略。


## **1. 代码环境**
 
```
pandas==1.4.2
gurobipy==9.5.1
matplotlib==3.3.4
numpy==1.22.3
pandas==1.4.2
PuLP==2.6.0
requests==2.25.1
xlrd==1.2.0
xlwt==1.3.0
```

- 搭环境的话请按照目录下的requirements.txt 进行安装
```pip install -r requirements.txt```
## **2. demo示例**
- 注：运行代码如下   
``` python optimization_24h.py```   
- 运行结果代码段如下：
```
python optimization_24h.py

Set parameter Username
Academic license - for non-commercial use only - expires 2023-03-04
Set parameter MIPGap to value 0.01
Gurobi Optimizer version 9.5.1 build v9.5.1rc2 (mac64[arm])
Thread count: 8 physical cores, 8 logical processors, using up to 8 threads
Optimize a model with 112 rows, 84 columns and 220 nonzeros
Model fingerprint: 0x21cfbd6b
Coefficient statistics:
  Matrix range     [2e-02, 2e+02]
  Objective range  [1e+00, 1e+00]
  Bounds range     [0e+00, 0e+00]
  RHS range        [4e+00, 1e+05]
Presolve removed 102 rows and 61 columns
Presolve time: 0.00s
Presolved: 10 rows, 23 columns, 50 nonzeros

Iteration    Objective       Primal Inf.    Dual Inf.      Time
       0    0.0000000e+00   6.287781e+01   0.000000e+00      0s
      10    2.9264384e+01   0.000000e+00   0.000000e+00      0s

Solved in 10 iterations and 0.00 seconds (0.00 work units)
Optimal objective  2.926438400e+01
```   
## **3.输入解释**

- 设备配置文件在`Config`文件夹下的`config.json`，由管理员进行配置。
- 模型的输入在`Input`文件夹下，主要由三部分组成

### **input_24h.xls**：主要负责日前决策程序的输入


+ ele_load:24小时每个小时的电负荷
+ g_load:24小时每个小时的热负荷
+ q_load:24小时每个小时的冷负荷
+ soalr:24小时每个小时的光照强度
+ day:当前日期
  
|    | ele\_load | g\_load | q\_load | solar | day |
| -- | --------- | ------- | ------- | ----- | --- |
| 0  | 30        | 50      | 50      | 0     | 13  |
| 1  | 30        | 50      | 50      | 0     | 13  |
| 2  | 30        | 50      | 50      | 0     | 13  |
| 3  | 30        | 50      | 50      | 0     | 13  |
| 4  | 30        | 50      | 50      | 0     | 13  |
| 5  | 30        | 50      | 50      | 0     | 13  |
| 6  | 80        | 80      | 80      | 0.01  | 13  |
| 7  | 150       | 150     | 150     | 0.13  | 13  |
| 8  | 290       | 290     | 290     | 0.3   | 13  |
| 9  | 250       | 250     | 250     | 0.4   | 13  |
| 10 | 200       | 200     | 200     | 0.58  | 13  |
| 11 | 80        | 80      | 80      | 0.66  | 13  |
| 12 | 60        | 60      | 60      | 0.67  | 13  |
| 13 | 150       | 150     | 150     | 0.6   | 13  |
| 14 | 180       | 180     | 180     | 0.51  | 13  |
| 15 | 220       | 220     | 220     | 0.36  | 13  |
| 16 | 360       | 360     | 360     | 0.21  | 13  |
| 17 | 480       | 480     | 480     | 0.05  | 13  |
| 18 | 550       | 550     | 550     | 0     | 13  |
| 19 | 420       | 420     | 420     | 0     | 13  |
| 20 | 320       | 320     | 320     | 0     | 13  |
| 21 | 280       | 280     | 280     | 0     | 13  |
| 22 | 180       | 180     | 180     | 0     | 13  |
| 23 | 110       | 110     | 110     | 0     | 13  |

### **input_4h.xls**：主要负责日内决策程序的输入

+ ele_load:未来4h每个小时的电负荷
+ g_load:未来4h每个小时的热负荷
+ q_load:未来4h每个小时的冷负荷
+ soalr:未来4h每个小时的光照强度
+ time:当前时间，例如：下午13点，填入13

|   | ele\_load | g\_load | q\_load | solar | time |
| - | --------- | ------- | ------- | ----- | ---- |
| 0 | 30        | 50      | 50      | 0     | 5    |
| 1 | 80        | 80      | 80      | 0.01  | 5    |
| 2 | 150       | 150     | 150     | 0.13  | 5    |
| 3 | 290       | 290     | 290     | 0.3   | 5    |

### **input_now.xls**
+ hydrogen_bottle_max:当前时刻气瓶组里的氢气容量(kg)
+ hst_kg:当前氢气缓冲瓶中氢气质量(kg)
+ t_ht:当前蓄能水箱温度
+ t_ct:当前消防水池温度
+ time:当前时刻在本日内的小时数

|   | hydrogen\_bottle\_max | hst\_kg | t\_ht | t\_ct | time | end\_slack |
| - | --------------------- | ------- | ----- | ----- | ---- | ---------- |
| 0 | 1000                  | 100     | 50    | 10    | 5    | FALSE      |

## **4.输出格式**
模型运行生成两个excel：   
### **dict_plot_24h.xls**

| opex\_without\_opt | opex       | op\_save\_part | renewable\_energy\_part | efficiency | p\_pur     | p\_pv | p\_fc | p\_hp      | p\_eb      | p\_pump    | p\_el | p\_load | h\_hst  | h\_sto\_l | h\_pur | h\_el | h\_fc | t\_ht      | g\_ht      | g\_load | g\_hp   | g\_eb    | g\_fc    | t\_ct      | q\_ct       | q\_hp      | q\_load |
| ------------------ | ---------- | -------------- | ----------------------- | ---------- | ---------- | ----- | ----- | ---------- | ---------- | ---------- | ----- | ------- | ------- | --------- | ------ | ----- | ----- | ---------- | ---------- | ------- | ------- | -------- | -------- | ---------- | ----------- | ---------- | ------- |
| 11431.6508         | 2877.94914 | 0.25175272     | 0.76244443              | 1.44163854 | 50         | 0     | 0     | 0          | 0          | 0          | 20    | 30      | 100.364 | 100       | 0      | 0.364 | 0     | 49.5714286 | \-50       | 50      | 0       | 0        | 0        | 10.4285714 | 50          | 0          | 50      |
|                    |            |                |                         |            | 50         | 0     | 0     | 0          | 0          | 0          | 20    | 30      | 100.728 | 100.364   | 0      | 0.364 | 0     | 49.1428571 | \-50       | 50      | 0       | 0        | 0        | 10.8571429 | 50          | 0          | 50      |
|                    |            |                |                         |            | 50         | 0     | 0     | 0          | 0          | 0          | 20    | 30      | 101.092 | 100.728   | 0      | 0.364 | 0     | 48.7142857 | \-50       | 50      | 0       | 0        | 0        | 11.2857143 | 50          | 0          | 50      |
|                    |            |                |                         |            | 50         | 0     | 0     | 0          | 0          | 0          | 20    | 30      | 101.456 | 101.092   | 0      | 0.364 | 0     | 48.2857143 | \-50       | 50      | 0       | 0        | 0        | 11.7142857 | 50          | 0          | 50      |
|                    |            |                |                         |            | 50         | 0     | 0     | 0          | 0          | 0          | 20    | 30      | 101.82  | 101.456   | 0      | 0.364 | 0     | 47.8571429 | \-50       | 50      | 0       | 0        | 0        | 12.1428571 | 50          | 0          | 50      |
|                    |            |                |                         |            | 50         | 0     | 0     | 0          | 0          | 0          | 20    | 30      | 102.184 | 101.82    | 0      | 0.364 | 0     | 47.4285714 | \-50       | 50      | 0       | 0        | 0        | 12.5714286 | 50          | 0          | 50      |
|                    |            |                |                         |            | 79         | 21    | 0     | 0          | 0          | 0          | 20    | 80      | 102.548 | 102.184   | 0      | 0.364 | 0     | 46.7428571 | \-80       | 80      | 0       | 0        | 0        | 13.2571429 | 80          | 0          | 80      |
|                    |            |                |                         |            | 0          | 273   | 0     | 0          | 103        | 0          | 20    | 150     | 102.912 | 102.548   | 0      | 0.364 | 0     | 46.2517143 | \-57.3     | 150     | 0       | 92.7     | 0        | 14.5428571 | 150         | 0          | 150     |
|                    |            |                |                         |            | 0          | 630   | 0     | 171.666667 | 148.333333 | 0          | 20    | 290     | 103.276 | 102.912   | 0      | 0.364 | 0     | 50.1191429 | 451.2      | 290     | 607.7   | 133.5    | 0        | 11.1428571 | \-396.66667 | 686.666667 | 290     |
|                    |            |                |                         |            | 0          | 840   | 0     | 0          | 229.976889 | 340.023111 | 20    | 250     | 103.64  | 103.276   | 0      | 0.364 | 0     | 49.7503931 | \-43.0208  | 250     | 0       | 206.9792 | 0        | 13.2857143 | 250         | 0          | 250     |
|                    |            |                |                         |            | 0          | 1218  | 0     | 0          | 0          | 998        | 20    | 200     | 104.004 | 103.64    | 0      | 0.364 | 0     | 48.0361074 | \-200      | 200     | 0       | 0        | 0        | 15         | 200         | 0          | 200     |
|                    |            |                |                         |            | 0          | 1386  | 0     | 340.833333 | 0          | 945.166667 | 20    | 80      | 104.368 | 104.004   | 0      | 0.364 | 0     | 57.6922503 | 1126.55    | 80      | 1206.55 | 0        | 0        | 4          | \-1283.3333 | 1363.33333 | 80      |
|                    |            |                |                         |            | 0          | 1407  | 0     | 0          | 0          | 1327       | 20    | 60      | 104.732 | 104.368   | 0      | 0.364 | 0     | 57.1779646 | \-60       | 60      | 0       | 0        | 0        | 4.51428571 | 60          | 0          | 60      |
|                    |            |                |                         |            | 0          | 1260  | 0     | 52.5       | 0          | 1037.5     | 20    | 150     | 105.096 | 104.732   | 0      | 0.364 | 0     | 57.4852503 | 35.85      | 150     | 185.85  | 0        | 0        | 4          | \-60        | 210        | 150     |
|                    |            |                |                         |            | 0          | 1071  | 0     | 45         | 0          | 826        | 20    | 180     | 105.46  | 105.096   | 0      | 0.364 | 0     | 57.3078217 | \-20.7     | 180     | 159.3   | 0        | 0        | 4          | 0           | 180        | 180     |
|                    |            |                |                         |            | 0          | 756   | 0     | 55         | 0          | 461        | 20    | 220     | 105.824 | 105.46    | 0      | 0.364 | 0     | 57.0909646 | \-25.3     | 220     | 194.7   | 0        | 0        | 4          | 0           | 220        | 220     |
|                    |            |                |                         |            | 9          | 441   | 0     | 90         | 0          | 0          | 0     | 360     | 105.824 | 105.824   | 0      | 0     | 0     | 56.7361074 | \-41.4     | 360     | 318.6   | 0        | 0        | 4          | 0           | 360        | 360     |
|                    |            |                |                         |            | 495        | 105   | 0     | 120        | 0          | 0          | 0     | 480     | 105.824 | 105.824   | 0      | 0     | 0     | 56.2629646 | \-55.2     | 480     | 424.8   | 0        | 0        | 4          | 0           | 480        | 480     |
|                    |            |                |                         |            | 458.846667 | 0     | 92.82 | 1.66666667 | 0          | 0          | 0     | 550     | 99.636  | 105.824   | 0      | 0     | 6.188 | 52.4797143 | \-441.3792 | 550     | 5.9     | 0        | 102.7208 | 8.65714286 | 543.333333  | 6.66666667 | 550     |
|                    |            |                |                         |            | 420        | 0     | 0     | 0          | 0          | 0          | 0     | 420     | 99.636  | 99.636    | 0      | 0     | 0     | 48.8797143 | \-420      | 420     | 0       | 0        | 0        | 12.2571429 | 420         | 0          | 420     |
|                    |            |                |                         |            | 320        | 0     | 0     | 0          | 0          | 0          | 0     | 320     | 99.636  | 99.636    | 0      | 0     | 0     | 46.1368571 | \-320      | 320     | 0       | 0        | 0        | 15         | 320         | 0          | 320     |
|                    |            |                |                         |            | 350        | 0     | 0     | 70         | 0          | 0          | 0     | 280     | 99.636  | 99.636    | 0      | 0     | 0     | 45.8608571 | \-32.2     | 280     | 247.8   | 0        | 0        | 15         | 0           | 280        | 280     |
|                    |            |                |                         |            | 225        | 0     | 0     | 45         | 0          | 0          | 0     | 180     | 99.636  | 99.636    | 0      | 0     | 0     | 45.6834286 | \-20.7     | 180     | 159.3   | 0        | 0        | 15         | 0           | 180        | 180     |
|                    |            |                |                         |            | 303.333333 | 0     | 0     | 173.333333 | 0          | 0          | 20    | 110     | 100     | 99.636    | 0      | 0.364 | 0     | 50         | 503.6      | 110     | 613.6   | 0        | 0        | 10         | \-583.33333 | 693.333333 | 110     |


+ opex_without_system:连续性变量，没有能源站设备情况下运行成本。
+ opex_without_opt:连续性变量，未经优化的运行成本
+ opex:连续性变量，优化决策后的运行成本
+ op_save_part:连续性变量，优化决策后的运行成本/未经优化的运行成本，运行成本节约比例。
+ renewable_energy_part:连续性变量，可再生能源占比
+ efficiency:连续性变量，综合能效
+ p_pur:连续性变量，逐时电网买电量。
+ p_pv:连续性变量，逐时光伏发电量。
+ p_fc:连续性变量，逐时燃料电池发电量。
+ p_hp:连续性变量，逐时热泵耗电量。
+ p_eb:连续性变量，逐时电锅炉耗电量。
+ p_pump:连续性变量，逐时循环水泵耗电量。
+ p_el:连续性变量，逐时电解槽耗电量。
+ p_load:连续性变量，逐时电负荷。
+ h_hst:连续性变量，逐时氢气缓冲瓶中氢气量(kg)。
+ h_sto_l:连续性变量，逐时的上时刻氢气缓冲瓶中氢气量(kg)(中间变量）
+ h_pur:连续性变量，逐时购氢量(kg)。
+ h_el:连续性变量，逐时电解槽制氢量(kg)。
+ h_fc:连续性变量，逐时燃料电池耗氢量(kg)。
+ h_tube:连续性变量，逐时气瓶组中剩余氢气量(kg)。
+ t_ht:连续性变量，逐时蓄能水箱温度(℃)。
+ g_ht:连续性变量，逐时蓄能水箱冲放能量(kwh)。
+ g_load:连续性变量，逐时热负荷(kwh)。
+ g_hp:连续性变量，逐时热泵产热量(kwh)。
+ g_eb:连续性变量，逐时电锅炉产热量(kwh)。
+ g_fc:连续性变量，逐时燃料电池产热量(kwh)。
+ t_ct:连续性变量，逐时蓄能水箱温度(℃)。
+ q_ct:连续性变量，逐时蓄能水箱充放冷量(kwh)。
+ q_hp:连续性变量，逐时热泵制冷量(kwh)。
+ q_load:连续性变量，逐时冷负荷(kwh)。


### **dict_control_24h.xls**

| time | b\_hp | b\_eb | b\_ht | b\_ct | b\_fc | p\_hp      | p\_eb      | p\_pump    | p\_fc | p\_el | h\_hst  | hydrogen\_bottle | t\_ht      | t\_ct      | t\_mp | m\_mp | g\_eb    |
| ---- | ----- | ----- | ----- | ----- | ----- | ---------- | ---------- | ---------- | ----- | ----- | ------- | ---------------- | ---------- | ---------- | ----- | ----- | -------- |
| 5    | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 100.364 | 1000             | 49.5714286 | 10.4285714 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 100.728 | 1000             | 49.1428571 | 10.8571429 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 101.092 | 1000             | 48.7142857 | 11.2857143 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 101.456 | 1000             | 48.2857143 | 11.7142857 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 101.82  | 1000             | 47.8571429 | 12.1428571 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 102.184 | 1000             | 47.4285714 | 12.5714286 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 20    | 102.548 | 1000             | 46.7428571 | 13.2571429 | 0     | 0     | 0        |
|      | 0     | 1     | 0     | 1     | 0     | 0          | 103        | 0          | 0     | 20    | 102.912 | 1000             | 46.2517143 | 14.5428571 | 0     | 0     | 92.7     |
|      | 1     | 1     | \-1   | 0     | 0     | 171.666667 | 148.333333 | 0          | 0     | 20    | 103.276 | 1000             | 50.1191429 | 11.1428571 | 0     | 0     | 133.5    |
|      | 0     | 1     | 0     | 1     | 0     | 0          | 229.976889 | 340.023111 | 0     | 20    | 103.64  | 1000             | 49.7503931 | 13.2857143 | 0     | 0     | 206.9792 |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 998        | 0     | 20    | 104.004 | 1000             | 48.0361074 | 15         | 0     | 0     | 0        |
|      | 1     | 0     | \-1   | 0     | 0     | 340.833333 | 0          | 945.166667 | 0     | 20    | 104.368 | 1000             | 57.6922503 | 4          | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 1327       | 0     | 20    | 104.732 | 1000             | 57.1779646 | 4.51428571 | 0     | 0     | 0        |
|      | 1     | 0     | \-1   | 0     | 0     | 52.5       | 0          | 1037.5     | 0     | 20    | 105.096 | 1000             | 57.4852503 | 4          | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 0     | 0     | 45         | 0          | 826        | 0     | 20    | 105.46  | 1000             | 57.3078217 | 4          | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 0     | 0     | 55         | 0          | 461        | 0     | 20    | 105.824 | 1000             | 57.0909646 | 4          | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 0     | 0     | 90         | 0          | 0          | 0     | 0     | 105.824 | 1000             | 56.7361074 | 4          | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 0     | 0     | 120        | 0          | 0          | 0     | 0     | 105.824 | 1000             | 56.2629646 | 4          | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 1     | 1     | 1.66666667 | 0          | 0          | 92.82 | 0     | 99.636  | 1000             | 52.4797143 | 8.65714286 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 0     | 99.636  | 1000             | 48.8797143 | 12.2571429 | 0     | 0     | 0        |
|      | 0     | 0     | 0     | 1     | 0     | 0          | 0          | 0          | 0     | 0     | 99.636  | 1000             | 46.1368571 | 15         | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 0     | 0     | 70         | 0          | 0          | 0     | 0     | 99.636  | 1000             | 45.8608571 | 15         | 0     | 0     | 0        |
|      | 1     | 0     | 0     | 0     | 0     | 45         | 0          | 0          | 0     | 0     | 99.636  | 1000             | 45.6834286 | 15         | 0     | 0     | 0        |
|      | 1     | 0     | \-1   | 0     | 0     | 173.333333 | 0          | 0          | 0     | 20    | 100     | 1000             | 50         | 10         | 0     | 0     | 0        |

+ time:
+ b_hp:零一变量，热泵开关机，0关闭，1开启
+ b_eb:零一变量，电锅炉开关机，0关闭，1开启
+ b_ht:整数变量，蓄能水箱工况，-1储能，1供能，0无工况
+ b_ct:整数变量，消防水池工况，-1储能，1供能，0无工况
+ b_fc:零一变量，燃料电池开关机，0关闭，1开启
+ p_hp:连续性变量，逐时间段的热泵电耗
+ p_eb:连续性变量，逐时电锅炉电耗
+ p_pump:连续性变量，逐时循环水泵耗电量。
+ p_fc:连续性变量，逐时燃料电池产电量
+ p_el:连续性变量，逐时电解槽耗电量。
+ h_hst:连续性变量，逐时缓冲罐内氢气质量。
+ hydrogen_bottle:连续性变量，逐时气瓶组内氢气质量。
+ t_ht:连续性变量，逐时蓄能水箱温度。
+ t_ct:连续性变量，逐时消防水池温度。
+ t_mp:连续性变量，逐时供热总管温度(未实现)。
+ m_mp:连续性变量，逐时供热总管流量(未实现)。
+ g_eb:连续性变量，逐时电锅炉制热量(kwh)。


注：
- FigPath：图片存放的完整路径
- FigName：文件的名称（作为区域摄像头唯一标识）
- PeapleNums：图片中的人数
- CaculationError：<font color=red>在计算该图片过程中是否出现异常，或计算是否有误</font>

## **5. 代码目录**

```
optimization
├─ Config
│  └─ config.json
├─ Input
│  ├─ generate_input_data.py
│  ├─ input_24h.xls
│  ├─ input_4h.xls
│  └─ input_now.xls
├─ Model
│  ├─ __pycache__
│  │  └─ optimization_day.cpython-310.pyc
│  └─ optimization_day.py
├─ Output
│  ├─ .DS_Store
│  ├─ control_output_24.xls
│  ├─ control_output_4.xls
│  ├─ dict_control_24h.xls
│  ├─ dict_control_4h.xls
│  ├─ dict_plot_24h.xls
│  ├─ dict_plot_4h.xls
│  └─ generate_out_data.py
├─ config.py
├─ cpeslog
│  ├─ __init__.py
│  ├─ __pycache__
│  │  ├─ __init__.cpython-310.pyc
│  │  ├─ __init__.cpython-37.pyc
│  │  ├─ log_code.cpython-310.pyc
│  │  └─ log_code.cpython-37.pyc
│  └─ log_code.py
├─ model.py
├─ my_test_log
│  ├─ _error.log
│  ├─ _info.log
│  ├─ _info.log.1
│  └─ _info.log.2
├─ optimization_24h.py
├─ optimization_4h.py
├─ readme.md
└─ requirements.txt

```

## **6. 可能存在的问题**

### 模型不可行的解决办法
如果无论是日前或者日内，出现模型不可行，或者模型结果计算错误。如何继续控制

### 末端时刻储能的调配
末端时刻储能调配很重要，调配好可以较大程度解决弃弃光。